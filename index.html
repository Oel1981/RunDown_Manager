<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundown Manager - DaVinci Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%);
            padding: 20px 30px;
            border-bottom: 2px solid #2a2a2a;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 100%);
            border-color: #5a5a5a;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: linear-gradient(180deg, #ff6b00 0%, #e85d00 100%);
            border-color: #ff7a1a;
        }

        .btn-primary:hover {
            background: linear-gradient(180deg, #ff7a1a 0%, #ff6b00 100%);
            border-color: #ff8a2a;
        }

        .btn-success {
            background: linear-gradient(180deg, #4caf50 0%, #45a049 100%);
            border-color: #5cb860;
        }

        .btn-danger {
            background: linear-gradient(180deg, #f44336 0%, #e53935 100%);
            border-color: #ff5a4e;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-add-event {
            width: 100%;
            padding: 5px;
            background: linear-gradient(180deg, #ffa500 0%, #ff8c00 100%);
            border: 1px solid #ffb733;
            border-radius: 6px;
            color: #000;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.2s;
            margin-top: 15px;
        }

        .btn-add-event:hover {
            background: linear-gradient(180deg, #ffb733 0%, #ffa500 100%);
            border-color: #ffc966;
            transform: scale(1.02);
        }

        .btn-add-event:active {
            transform: scale(0.98);
        }

        .btn-arrow {
            width: 40px;
            height: 40px;
            padding: 0;
            background: linear-gradient(180deg, #ffa500 0%, #ff8c00 100%);
            border: 1px solid #ffb733;
            border-radius: 4px;
            color: #000;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-arrow:hover {
            background: linear-gradient(180deg, #ffb733 0%, #ffa500 100%);
            border-color: #ffc966;
        }

        .btn-arrow:active {
            transform: scale(0.95);
        }

        .event-order-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 10px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Event Form */
        .event-form {
            background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .event-form h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #ff6b00;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #0a0a0a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff6b00;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Stats Panel */
        .stats-panel {
            background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .stats-panel h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #ff6b00;
            font-weight: 600;
        }

        .stat-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            font-variant-numeric: tabular-nums;
        }

        .stat-value.active {
            color: #ff6b00;
        }

        .progress-bar {
            height: 6px;
            background: #2a2a2a;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b00 0%, #ff8a2a 100%);
            transition: width 0.3s;
            border-radius: 3px;
        }

        /* Events List */
        .events-section {
            background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .events-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #ff6b00;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Event Item */
        .event-item {
            background: #0a0a0a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 15px;
            cursor: grab;
            transition: all 0.2s;
        }

        .event-item:active {
            cursor: grabbing;
        }

        .event-item.dragging {
            opacity: 0.5;
        }

        .event-item.drag-over {
            border-color: #ff6b00;
            background: #1a1a1a;
        }

        .event-item.current {
            border-color: #ff6b00;
            background: linear-gradient(180deg, #1a0f00 0%, #0a0a0a 100%);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.3);
        }

        .event-item.completed {
            opacity: 0.6;
            border-color: #2a2a2a;
        }

        /* Event Item Category Colors */
        .event-item.cat-intro { border-left: 4px solid #4caf50; background: linear-gradient(90deg, rgba(26, 77, 46, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-video { border-left: 4px solid #2196f3; background: linear-gradient(90deg, rgba(26, 58, 92, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-live { border-left: 4px solid #f44336; background: linear-gradient(90deg, rgba(92, 26, 26, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-music { border-left: 4px solid #9c27b0; background: linear-gradient(90deg, rgba(77, 26, 92, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-grafica { border-left: 4px solid #00bcd4; background: linear-gradient(90deg, rgba(26, 92, 92, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-rvm { border-left: 4px solid #ff6b00; background: linear-gradient(90deg, rgba(92, 58, 26, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-break { border-left: 4px solid #ff9800; background: linear-gradient(90deg, rgba(92, 77, 26, 0.2) 0%, #0a0a0a 100%); }
        .event-item.cat-other { border-left: 4px solid #888; background: linear-gradient(90deg, rgba(42, 42, 42, 0.2) 0%, #0a0a0a 100%); }
        
        .event-item.current.cat-intro { background: linear-gradient(90deg, rgba(26, 77, 46, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-video { background: linear-gradient(90deg, rgba(26, 58, 92, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-live { background: linear-gradient(90deg, rgba(92, 26, 26, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-music { background: linear-gradient(90deg, rgba(77, 26, 92, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-grafica { background: linear-gradient(90deg, rgba(26, 92, 92, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-rvm { background: linear-gradient(90deg, rgba(92, 58, 26, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-break { background: linear-gradient(90deg, rgba(92, 77, 26, 0.3) 0%, #1a0f00 100%); }
        .event-item.current.cat-other { background: linear-gradient(90deg, rgba(42, 42, 42, 0.3) 0%, #1a0f00 100%); }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .event-category {
            display: inline-block;
            padding: 3px 8px;
            background: #2a2a2a;
            border-radius: 3px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .event-notes {
            font-size: 13px;
            color: #888;
            margin-top: 6px;
            line-height: 1.4;
        }

        .event-timer {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            font-variant-numeric: tabular-nums;
            margin-left: 15px;
            min-width: 120px;
            text-align: right;
        }

        .event-timer.warning {
            color: #ffa500;
        }

        .event-timer.danger {
            color: #ff4444;
        }

        .event-timer.completed {
            color: #4caf50;
        }

        .event-duration {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .event-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #2a2a2a;
        }

        /* Category Colors */
        .category-intro { background: #1a4d2e; color: #4caf50; }
        .category-video { background: #1a3a5c; color: #2196f3; }
        .category-live { background: #5c1a1a; color: #f44336; }
        .category-music { background: #4d1a5c; color: #9c27b0; }
        .category-grafica { background: #1a5c5c; color: #00bcd4; }
        .category-rvm { background: #5c3a1a; color: #ff6b00; }
        .category-break { background: #5c4d1a; color: #ff9800; }
        .category-other { background: #2a2a2a; color: #888; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* File Input */
        input[type="file"] {
            display: none;
        }

        /* Auto-advance indicator */
        .auto-advance-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #1a4d2e;
            border-radius: 4px;
            font-size: 13px;
            color: #4caf50;
        }

        .auto-advance-indicator.disabled {
            background: #2a2a2a;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #4caf50;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .event-header {
                flex-direction: column;
            }
            
            .event-timer {
                margin-left: 0;
                margin-top: 10px;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 contenteditable="true" id="rundownTitle" style="outline: none; cursor: text;">Rundown Manager</h1>
            <div style="font-size: 12px; color: #888; margin-top: -10px; margin-bottom: 10px;">¬© LeoCianci</div>
            <div class="header-controls">
                <button class="btn btn-primary" onclick="app.addEvent()">‚ûï Aggiungi Evento</button>
                <button class="btn" onclick="app.saveRundown()">Salva Rundown</button>
                <button class="btn" onclick="app.loadRundown()">Carica Rundown</button>
                <button class="btn btn-danger" onclick="app.resetAll()">Reset Totale</button>
                <div class="auto-advance-indicator" id="autoAdvanceIndicator">
                    <div class="toggle-switch active" onclick="app.toggleAutoAdvance()">
                        <div class="toggle-slider"></div>
                    </div>
                    <span>Auto-avanzamento attivo</span>
                </div>
                <button class="btn" onclick="app.openSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                    Settings
                </button>
                <button class="btn" onclick="app.openCompanion()"> Companion</button>
            </div>
            <div id="activeSettings" style="display: none; margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 6px; border: 1px solid #2a2a2a;">
                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">Configurazione Attiva:</div>
                <div id="activeSettingsContent"></div>
            </div>
        </div>

        <div class="main-layout">
            <div class="event-form">
                <h2>Nuovo Evento</h2>
                <div class="form-group">
                    <label>Nome Evento</label>
                    <input type="text" id="eventName" placeholder="Es: Apertura Cerimonia">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Durata (mm:ss)</label>
                        <input type="text" id="eventDuration" placeholder="05:30" value="05:00">
                    </div>
                    <div class="form-group">
                        <label>Orario Inizio (HH:MM:SS)</label>
                        <input type="text" id="eventStartTime" placeholder="20:30:00 (opzionale)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="eventCategory">
                        <option value="intro">Intro</option>
                        <option value="video">Video</option>
                        <option value="live">Live</option>
                        <option value="music">Musica</option>
                        <option value="grafica">Grafica</option>
                        <option value="rvm">RVM</option>
                        <option value="break">Pausa</option>
                        <option value="other">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Crosspoint (XPT)</label>
                    <select id="eventXPT">
                        <option value="">Nessuno</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="eventNotes" placeholder="Inserisci note, cue tecnici, ecc..."></textarea>
                </div>
                <button class="btn-add-event" onclick="app.addEvent()">+</button>
            </div>

            <div class="stats-panel">
                <h2>Statistiche Show</h2>
                <div class="stat-item">
                    <div class="stat-label">Countdown Inizio Show</div>
                    <div class="stat-value" id="showCountdown">--:--:--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tempo Totale Show</div>
                    <div class="stat-value" id="totalTime">00:00:00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tempo Corrente</div>
                    <div class="stat-value active" id="currentTime">00:00:00</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Eventi</div>
                    <div class="stat-value"><span id="completedEvents">0</span> / <span id="totalEvents">0</span></div>
                </div>
            </div>
        </div>

        <div class="events-section">
            <h2>
                <span>Eventi in Programma</span>
                <button class="btn btn-small btn-danger" onclick="app.clearAll()">üóëÔ∏è Pulisci Tutto</button>
            </h2>
            <div class="events-list" id="eventsList"></div>
        </div>

        <div class="events-section" style="margin-top: 20px;">
            <h2>Eventi Completati</h2>
            <div class="events-list" id="completedList"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; overflow-y: auto;">
        <div style="max-width: 800px; margin: 40px auto; background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%); border-radius: 8px; border: 2px solid #2a2a2a; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-size: 24px; color: #ff6b00; margin: 0;">‚öôÔ∏è Settings</h2>
                <button class="btn btn-danger" onclick="app.closeSettings()">‚úï Chiudi</button>
            </div>

            <div style="background: #0a0a0a; padding: 20px; border-radius: 6px; border: 1px solid #2a2a2a; margin-bottom: 20px;">
                <h3 style="font-size: 16px; color: #ffffff; margin-bottom: 15px;">Mixer Configuration</h3>
                
                <div class="form-group">
                    <label>Tipo Mixer</label>
                    <select id="settingsMixer" onchange="app.updateMixerType()">
                        <option value="none">Nessuno</option>
                        <option value="blackmagic">Blackmagic ATEM</option>
                        <option value="sony_xvs">Sony XVS</option>
                        <option value="grass_valley">Grass Valley</option>
                        <option value="for_a">FOR-A</option>
                    </select>
                </div>

                <div id="mixerIPSettings" style="display: none;">
                    <div class="form-group">
                        <label>IP Address Mixer</label>
                        <input type="text" id="mixerIP" placeholder="192.168.1.100" onchange="app.updateSettings()">
                    </div>
                    <div class="form-group">
                        <label>Port</label>
                        <input type="text" id="mixerPort" placeholder="9910" onchange="app.updateSettings()">
                    </div>
                </div>
            </div>

            <div style="background: #0a0a0a; padding: 20px; border-radius: 6px; border: 1px solid #2a2a2a; margin-bottom: 20px;">
                <h3 style="font-size: 16px; color: #ffffff; margin-bottom: 15px;">PTZ Camera Control</h3>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="settingsPTZ" onchange="app.togglePTZ()" style="width: auto;">
                        <span>Abilita Controllo PTZ</span>
                    </label>
                </div>

                <div id="ptzSettings" style="display: none; margin-left: 0px; margin-top: 10px;">
                    <div class="form-group">
                        <label>Protocollo PTZ</label>
                        <select id="ptzProtocol" onchange="app.updateSettings()">
                            <option value="panasonic">Panasonic</option>
                            <option value="sony">Sony</option>
                            <option value="visca">VISCA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PTZ IP Address</label>
                        <input type="text" id="ptzIP" placeholder="192.168.1.10" onchange="app.updateSettings()">
                    </div>
                    <div class="form-group">
                        <label>PTZ Port</label>
                        <input type="text" id="ptzPort" placeholder="52381" onchange="app.updateSettings()">
                    </div>
                </div>
            </div>

            <div style="background: #0a0a0a; padding: 20px; border-radius: 6px; border: 1px solid #2a2a2a; margin-bottom: 20px;">
                <h3 style="font-size: 16px; color: #ffffff; margin-bottom: 15px;">Protocolli di Controllo</h3>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="settingsOSC" onchange="app.toggleOSC()" style="width: auto;">
                        <span>Abilita Comandi OSC</span>
                    </label>
                </div>

                <div id="oscSettings" style="display: none; margin-left: 30px; margin-top: 10px;">
                    <div class="form-group">
                        <label>OSC IP Address</label>
                        <input type="text" id="oscIP" placeholder="127.0.0.1" onchange="app.updateSettings()">
                    </div>
                    <div class="form-group">
                        <label>OSC Port (In/Out)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="text" id="oscPortIn" placeholder="8000" onchange="app.updateSettings()">
                            <input type="text" id="oscPortOut" placeholder="9000" onchange="app.updateSettings()">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="settingsAPI" onchange="app.toggleAPI()" style="width: auto;">
                        <span>Abilita Comandi API</span>
                    </label>
                </div>

                <div id="apiSettings" style="display: none; margin-left: 30px; margin-top: 10px;">
                    <div class="form-group">
                        <label>API Endpoint</label>
                        <input type="text" id="apiEndpoint" placeholder="http://localhost:3000/api" onchange="app.updateSettings()">
                    </div>
                    <div class="form-group">
                        <label>API Key (opzionale)</label>
                        <input type="text" id="apiKey" placeholder="your-api-key" onchange="app.updateSettings()">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="settingsGPIO" onchange="app.toggleGPIO()" style="width: auto;">
                        <span>Abilita GPI/O</span>
                    </label>
                </div>

                <div id="gpioSettings" style="display: none; margin-left: 30px; margin-top: 10px;">
                    <div class="form-group">
                        <label>GPIO Device IP</label>
                        <input type="text" id="gpioIP" placeholder="192.168.1.50" onchange="app.updateSettings()">
                    </div>
                    <div class="form-group">
                        <label>GPIO Port</label>
                        <input type="text" id="gpioPort" placeholder="5000" onchange="app.updateSettings()">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn" onclick="app.testConnection()">üîå Test Connessione</button>
                <button class="btn btn-success" onclick="app.saveSettingsAndClose()">üíæ Salva e Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            events: [],
            currentEventIndex: -1,
            timers: {},
            autoAdvance: true,
            currentShowTime: 0,
            showTimer: null,
            showStarted: false,
            countdownTimer: null,
            autoStartTimer: null,
            settings: {
                mixer: 'none',
                mixerIP: '',
                mixerPort: '',
                ptzEnabled: false,
                ptzProtocol: 'panasonic',
                ptzIP: '',
                ptzPort: '',
                oscEnabled: false,
                oscIP: '127.0.0.1',
                oscPortIn: '8000',
                oscPortOut: '9000',
                apiEnabled: false,
                apiEndpoint: '',
                apiKey: '',
                gpioEnabled: false,
                gpioIP: '',
                gpioPort: ''
            },

            init() {
                this.loadFromLocalStorage();
                this.render();
                this.updateStats();
                this.startCountdownTimer();
                this.checkAutoStart();
                this.loadSettings();
                
                // Popola il select XPT con 120 opzioni
                const xptSelect = document.getElementById('eventXPT');
                for (let i = 1; i <= 120; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Input ${i}`;
                    xptSelect.appendChild(option);
                }
                
                // Carica il titolo salvato
                const savedTitle = localStorage.getItem('rundown_title');
                if (savedTitle) {
                    document.getElementById('rundownTitle').textContent = savedTitle;
                }
                
                // Salva il titolo quando viene modificato
                document.getElementById('rundownTitle').addEventListener('blur', () => {
                    const title = document.getElementById('rundownTitle').textContent.trim();
                    if (title) {
                        localStorage.setItem('rundown_title', title);
                    }
                });
                
                // Formattazione automatica durata
                document.getElementById('eventDuration').addEventListener('blur', (e) => {
                    const formatted = this.formatDurationInput(e.target.value);
                    e.target.value = formatted;
                });
                
                // Formattazione automatica orario
                document.getElementById('eventStartTime').addEventListener('blur', (e) => {
                    const formatted = this.formatTimeInput(e.target.value);
                    e.target.value = formatted;
                });
                
                // Navigazione con Enter tra i campi del form
                const formFields = ['eventName', 'eventDuration', 'eventStartTime', 'eventCategory', 'eventXPT', 'eventNotes'];
                formFields.forEach((fieldId, index) => {
                    const field = document.getElementById(fieldId);
                    field.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            
                            // Se siamo sull'ultimo campo (note), non fare nulla
                            // L'utente deve cliccare + o usare Cmd/Ctrl+N
                            if (index < formFields.length - 1) {
                                // Vai al prossimo campo
                                document.getElementById(formFields[index + 1]).focus();
                            }
                        }
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;
                    
                    // Cmd/Ctrl + N = Aggiungi Evento (e focus su nome)
                    if (cmdOrCtrl && e.key.toLowerCase() === 'n') {
                        e.preventDefault();
                        // Se siamo gi√† nel form, aggiungi l'evento
                        const activeElement = document.activeElement;
                        const isInForm = formFields.some(id => document.getElementById(id) === activeElement);
                        
                        if (isInForm) {
                            this.addEvent();
                        } else {
                            document.getElementById('eventName').focus();
                        }
                    }
                    
                    // Cmd/Ctrl + R = Reset Totale
                    if (cmdOrCtrl && e.key.toLowerCase() === 'r') {
                        e.preventDefault();
                        this.resetAll();
                    }
                });
            },

            addEvent() {
                const name = document.getElementById('eventName').value.trim();
                const durationStr = document.getElementById('eventDuration').value.trim();
                const startTimeStr = document.getElementById('eventStartTime').value.trim();
                const category = document.getElementById('eventCategory').value;
                const xpt = document.getElementById('eventXPT').value.trim();
                const notes = document.getElementById('eventNotes').value.trim();

                if (!name) {
                    alert('Inserisci un nome per l\'evento');
                    return;
                }

                const duration = this.parseDuration(durationStr);
                if (duration === 0) {
                    alert('Durata non valida. Usa formato mm:ss (es: 05:30)');
                    return;
                }

                const event = {
                    id: Date.now(),
                    name,
                    duration,
                    category,
                    xpt: xpt || null,
                    notes,
                    startTime: startTimeStr || null,
                    status: 'waiting', // waiting, running, completed
                    elapsed: 0
                };

                this.events.push(event);
                this.saveToLocalStorage();
                this.render();
                this.updateStats();

                // Clear form
                document.getElementById('eventName').value = '';
                document.getElementById('eventDuration').value = '05:00';
                document.getElementById('eventStartTime').value = '';
                document.getElementById('eventXPT').value = '';
                document.getElementById('eventNotes').value = '';
                document.getElementById('eventName').focus();
            },

            parseDuration(str) {
                const parts = str.split(':');
                if (parts.length === 2) {
                    const minutes = parseInt(parts[0]) || 0;
                    const seconds = parseInt(parts[1]) || 0;
                    return minutes * 60 + seconds;
                }
                return 0;
            },

            formatDurationInput(input) {
                // Rimuovi tutto tranne i numeri
                const numbers = input.replace(/\D/g, '');
                
                if (!numbers) return '00:00';
                
                const num = parseInt(numbers);
                
                // Se √® solo un numero piccolo (< 60), consideralo come secondi
                if (num < 60 && numbers.length <= 2) {
                    return `00:${num.toString().padStart(2, '0')}`;
                }
                
                // Se sono 3-4 cifre, trattale come MMSS
                if (numbers.length <= 4) {
                    const minutes = Math.floor(num / 100);
                    const seconds = num % 100;
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Per numeri pi√π lunghi, prendi le ultime 4 cifre come MMSS
                const lastFour = numbers.slice(-4);
                const minutes = Math.floor(parseInt(lastFour) / 100);
                const seconds = parseInt(lastFour) % 100;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },

            formatTimeInput(input) {
                if (!input || input.trim() === '') return '';
                
                // Rimuovi tutto tranne i numeri
                const numbers = input.replace(/\D/g, '');
                
                if (!numbers) return '';
                
                // Se ci sono gi√† i : usa il formato esistente
                if (input.includes(':')) {
                    const parts = input.split(':');
                    if (parts.length === 2) {
                        // HH:MM
                        const hours = parseInt(parts[0]) || 0;
                        const minutes = parseInt(parts[1]) || 0;
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00`;
                    } else if (parts.length === 3) {
                        // HH:MM:SS
                        const hours = parseInt(parts[0]) || 0;
                        const minutes = parseInt(parts[1]) || 0;
                        const seconds = parseInt(parts[2]) || 0;
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
                
                // Formatta in base al numero di cifre
                if (numbers.length <= 2) {
                    // Solo minuti (es: 30 -> 00:30:00)
                    const minutes = parseInt(numbers);
                    return `00:${minutes.toString().padStart(2, '0')}:00`;
                } else if (numbers.length <= 4) {
                    // HHMM (es: 2030 -> 20:30:00)
                    const hours = parseInt(numbers.substring(0, numbers.length - 2));
                    const minutes = parseInt(numbers.substring(numbers.length - 2));
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00`;
                } else if (numbers.length <= 6) {
                    // HHMMSS (es: 203045 -> 20:30:45)
                    const hours = parseInt(numbers.substring(0, numbers.length - 4));
                    const minutes = parseInt(numbers.substring(numbers.length - 4, numbers.length - 2));
                    const seconds = parseInt(numbers.substring(numbers.length - 2));
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                return input;
            },

            parseTime(timeStr) {
                if (!timeStr || timeStr.trim() === '') return null;
                
                const trimmed = timeStr.trim();
                const parts = trimmed.split(':');
                
                if (parts.length === 2) {
                    // HH:MM
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    
                    if (!isNaN(hours) && !isNaN(minutes) && 
                        hours >= 0 && hours < 24 && 
                        minutes >= 0 && minutes < 60) {
                        console.log('Parsed time (HH:MM):', timeStr, '‚Üí', { hours, minutes });
                        return { hours, minutes };
                    }
                } else if (parts.length === 3) {
                    // HH:MM:SS - usiamo solo ore e minuti
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    
                    if (!isNaN(hours) && !isNaN(minutes) && 
                        hours >= 0 && hours < 24 && 
                        minutes >= 0 && minutes < 60) {
                        console.log('Parsed time (HH:MM:SS):', timeStr, '‚Üí', { hours, minutes });
                        return { hours, minutes };
                    }
                }
                
                console.log('Failed to parse time:', timeStr);
                return null;
            },

            formatTime(seconds) {
                const absSeconds = Math.abs(seconds);
                const h = Math.floor(absSeconds / 3600);
                const m = Math.floor((absSeconds % 3600) / 60);
                const s = absSeconds % 60;
                
                const sign = seconds < 0 ? '-' : '';
                
                if (h > 0) {
                    return `${sign}${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }
                return `${sign}${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            },

            getFirstEventStartTime() {
                // Trova il primo evento in attesa che ha un orario impostato
                const firstEventWithTime = this.events.find(e => e.startTime && e.startTime.trim() !== '' && e.status === 'waiting');
                if (!firstEventWithTime) return null;
                
                const parsed = this.parseTime(firstEventWithTime.startTime);
                console.log('First event with time:', firstEventWithTime.name, firstEventWithTime.startTime, 'Parsed:', parsed);
                return parsed;
            },

            startCountdownTimer() {
                this.countdownTimer = setInterval(() => {
                    this.updateCountdown();
                }, 1000);
                this.updateCountdown();
            },

            updateCountdown() {
                const startTime = this.getFirstEventStartTime();
                const countdownEl = document.getElementById('showCountdown');
                
                if (!countdownEl) {
                    console.error('Countdown element not found!');
                    return;
                }
                
                // Verifica se c'√® almeno un evento running o completed
                const hasStartedEvents = this.events.some(e => e.status === 'running' || e.status === 'completed');
                
                if (!startTime) {
                    console.log('No start time found');
                    countdownEl.textContent = '--:--:--';
                    countdownEl.style.color = '#666';
                    return;
                }

                if (hasStartedEvents) {
                    countdownEl.textContent = 'SHOW STARTED';
                    countdownEl.style.color = '#ff6b00';
                    return;
                }

                const now = new Date();
                const target = new Date();
                target.setHours(startTime.hours, startTime.minutes, 0, 0);

                console.log('Countdown - Now:', now.toLocaleTimeString(), 'Target:', target.toLocaleTimeString());

                // Se l'orario √® gi√† passato oggi, considera domani
                if (target <= now) {
                    target.setDate(target.getDate() + 1);
                    console.log('Target was in the past, moved to tomorrow:', target.toLocaleTimeString());
                }

                const diff = Math.floor((target - now) / 1000);
                console.log('Time difference (seconds):', diff);

                if (diff <= 0) {
                    countdownEl.textContent = '00:00:00';
                    countdownEl.style.color = '#ff6b00';
                } else if (diff <= 60) {
                    countdownEl.textContent = this.formatTime(diff);
                    countdownEl.style.color = '#ff4444';
                } else if (diff <= 300) {
                    countdownEl.textContent = this.formatTime(diff);
                    countdownEl.style.color = '#ffa500';
                } else {
                    countdownEl.textContent = this.formatTime(diff);
                    countdownEl.style.color = '#4caf50';
                }
            },

            checkAutoStart() {
                // Controlla ogni secondo se ci sono eventi da avviare automaticamente
                this.autoStartTimer = setInterval(() => {
                    // Non auto-startare se c'√® gi√† un evento in esecuzione
                    const hasRunningEvent = this.events.some(e => e.status === 'running');
                    if (hasRunningEvent) return;
                    
                    const now = new Date();
                    const currentHours = now.getHours();
                    const currentMinutes = now.getMinutes();
                    const currentSeconds = now.getSeconds();
                    
                    // Auto-start solo al secondo 0 dell'orario impostato
                    if (currentSeconds !== 0) return;
                    
                    this.events.forEach((event, index) => {
                        if (event.status === 'waiting' && event.startTime) {
                            const eventTime = this.parseTime(event.startTime);
                            if (eventTime && 
                                eventTime.hours === currentHours && 
                                eventTime.minutes === currentMinutes) {
                                // Avvia automaticamente l'evento
                                console.log('Auto-starting event:', event.name, 'at', event.startTime);
                                this.startEvent(index);
                            }
                        }
                    });
                }, 1000);
            },

            startEvent(index) {
                // Stop any running event
                this.events.forEach((e, i) => {
                    if (e.status === 'running') {
                        this.stopEvent(i);
                    }
                });

                this.currentEventIndex = index;
                const event = this.events[index];
                event.status = 'running';

                // Avvia il tempo corrente dello show alla partenza del primo evento
                if (!this.showStarted) {
                    this.showStarted = true;
                    this.startShowTimer();
                }

                // Esegui comandi dell'evento
                this.executeEventCommands(event);

                this.timers[event.id] = setInterval(() => {
                    event.elapsed++;
                    this.render();

                    // Check if event completed
                    if (event.elapsed >= event.duration) {
                        this.completeEvent(index);
                    }
                }, 1000);

                this.render();
            },

            executeEventCommands(event) {
                console.log('=== Executing Event Commands ===');
                console.log('Event:', event.name);
                
                // Mixer XPT
                if (this.settings.mixer !== 'none' && event.xpt) {
                    console.log(`üéöÔ∏è Mixer: Switching to Input ${event.xpt} on ${this.settings.mixer}`);
                    // Qui implementare la logica di switch mixer
                }
                
                // PTZ Memory
                if (this.settings.ptzEnabled && event.ptzMemory) {
                    console.log(`üìπ PTZ: Recalling Memory ${event.ptzMemory} (${this.settings.ptzProtocol})`);
                    // Qui implementare il recall PTZ
                }
                
                // OSC Command
                if (this.settings.oscEnabled && event.oscCommand) {
                    console.log(`üì° OSC: Sending command ${event.oscCommand} to ${this.settings.oscIP}:${this.settings.oscPortOut}`);
                    // Qui implementare invio OSC
                }
                
                // API Command
                if (this.settings.apiEnabled && event.apiCommand) {
                    console.log(`üîå API: Calling ${this.settings.apiEndpoint}${event.apiCommand}`);
                    // Qui implementare chiamata API
                }
                
                // GPIO Command
                if (this.settings.gpioEnabled && event.gpioCommand) {
                    console.log(`‚ö° GPIO: Triggering Pin ${event.gpioCommand} on ${this.settings.gpioIP}`);
                    // Qui implementare trigger GPIO
                }
                
                console.log('================================');
            },

            stopEvent(index) {
                const event = this.events[index];
                if (this.timers[event.id]) {
                    clearInterval(this.timers[event.id]);
                    delete this.timers[event.id];
                }
                event.status = 'waiting';
                this.render();
            },

            resetEvent(index) {
                const event = this.events[index];
                if (this.timers[event.id]) {
                    clearInterval(this.timers[event.id]);
                    delete this.timers[event.id];
                }
                event.elapsed = 0;
                event.status = 'waiting';
                this.render();
            },

            completeEvent(index) {
                const event = this.events[index];
                if (this.timers[event.id]) {
                    clearInterval(this.timers[event.id]);
                    delete this.timers[event.id];
                }
                event.status = 'completed';
                
                this.render();
                this.updateStats();
                this.saveToLocalStorage();
                
                // Auto-advance to next event (sempre, non solo se autoAdvance √® true)
                // Cerca il prossimo evento in attesa nella lista
                const nextIndex = this.events.findIndex((e, i) => i > index && e.status === 'waiting');
                if (nextIndex !== -1) {
                    setTimeout(() => {
                        this.startEvent(nextIndex);
                    }, 500);
                }
            },

            deleteEvent(index) {
                if (confirm('Eliminare questo evento?')) {
                    const event = this.events[index];
                    if (this.timers[event.id]) {
                        clearInterval(this.timers[event.id]);
                        delete this.timers[event.id];
                    }
                    this.events.splice(index, 1);
                    this.saveToLocalStorage();
                    this.render();
                    this.updateStats();
                }
            },

            toggleAutoAdvance() {
                this.autoAdvance = !this.autoAdvance;
                const indicator = document.getElementById('autoAdvanceIndicator');
                const toggle = indicator.querySelector('.toggle-switch');
                
                if (this.autoAdvance) {
                    toggle.classList.add('active');
                    indicator.classList.remove('disabled');
                    indicator.querySelector('span').textContent = 'Auto-avanzamento attivo';
                } else {
                    toggle.classList.remove('active');
                    indicator.classList.add('disabled');
                    indicator.querySelector('span').textContent = 'Auto-avanzamento disattivo';
                }
                this.saveToLocalStorage();
            },

            startShowTimer() {
                if (this.showTimer) return; // Gi√† avviato
                
                this.showTimer = setInterval(() => {
                    this.currentShowTime++;
                    document.getElementById('currentTime').textContent = this.formatTime(this.currentShowTime);
                    this.updateProgressBar();
                }, 1000);
            },

            updateStats() {
                const total = this.events.reduce((sum, e) => sum + e.duration, 0);
                const completed = this.events.filter(e => e.status === 'completed').length;
                
                document.getElementById('totalTime').textContent = this.formatTime(total);
                document.getElementById('totalEvents').textContent = this.events.length;
                document.getElementById('completedEvents').textContent = completed;
                
                this.updateProgressBar();
            },

            updateProgressBar() {
                const total = this.events.reduce((sum, e) => sum + e.duration, 0);
                const progress = total > 0 ? (this.currentShowTime / total) * 100 : 0;
                document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
            },

            render() {
                const activeList = document.getElementById('eventsList');
                const completedList = document.getElementById('completedList');
                
                const activeEvents = this.events.filter(e => e.status !== 'completed');
                const completedEvents = this.events.filter(e => e.status === 'completed');

                // Render active events
                if (activeEvents.length === 0) {
                    activeList.innerHTML = `
                        <div class="empty-state">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                            </svg>
                            <p>Nessun evento in programma.<br>Aggiungi il primo evento per iniziare!</p>
                        </div>
                    `;
                } else {
                    activeList.innerHTML = activeEvents.map((event, index) => {
                        const actualIndex = this.events.indexOf(event);
                        return this.renderEvent(event, actualIndex);
                    }).join('');
                }

                // Render completed events
                if (completedEvents.length === 0) {
                    completedList.innerHTML = `
                        <div class="empty-state">
                            <p style="font-size: 14px;">Nessun evento completato</p>
                        </div>
                    `;
                } else {
                    completedList.innerHTML = completedEvents.map((event, index) => {
                        const actualIndex = this.events.indexOf(event);
                        return this.renderEvent(event, actualIndex);
                    }).join('');
                }

                this.setupDragAndDrop();
            },

            renderEvent(event, index) {
                const remaining = event.duration - event.elapsed;
                const percentage = (event.elapsed / event.duration) * 100;
                
                let timerClass = '';
                if (event.status === 'completed') {
                    timerClass = 'completed';
                } else if (remaining <= 10 && event.status === 'running') {
                    timerClass = 'danger';
                } else if (remaining <= 30 && event.status === 'running') {
                    timerClass = 'warning';
                }

                const isCurrent = event.status === 'running';
                const isCompleted = event.status === 'completed';

                const startTimeDisplay = event.startTime ? `<span style="font-size: 11px; color: #888; margin-left: 8px;">‚è∞ ${event.startTime}</span>` : '';
                
                // XPT Display come select dropdown (solo se mixer √® attivo)
                let xptDisplay = '';
                if (this.settings.mixer !== 'none') {
                    const xptOptions = Array.from({length: 120}, (_, i) => {
                        const value = i + 1;
                        const selected = event.xpt == value ? 'selected' : '';
                        return `<option value="${value}" ${selected}>Input ${value}</option>`;
                    }).join('');
                    
                    xptDisplay = `
                        <div style="margin-top: 6px;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 2px;">Mixer XPT:</label>
                            <select onchange="app.updateEventXPT(${index}, this.value)" style="padding: 4px 8px; background: #0a0a0a; border: 1px solid #ffa500; border-radius: 4px; color: #ffa500; font-size: 11px; cursor: pointer;">
                                <option value="">Nessuno</option>
                                ${xptOptions}
                            </select>
                        </div>
                    `;
                }

                // PTZ Memory Display (solo se PTZ √® attivo)
                let ptzDisplay = '';
                if (this.settings.ptzEnabled) {
                    const ptzMemory = event.ptzMemory || '';
                    ptzDisplay = `
                        <div style="margin-top: 6px;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 2px;">PTZ Memory:</label>
                            <input type="text" value="${ptzMemory}" onchange="app.updateEventPTZ(${index}, this.value)" 
                                   placeholder="Es: 1, 2, 3..." 
                                   style="width: 100%; padding: 4px 8px; background: #0a0a0a; border: 1px solid #9c27b0; border-radius: 4px; color: #9c27b0; font-size: 11px;">
                        </div>
                    `;
                }

                // OSC Command Display (solo se OSC √® attivo)
                let oscDisplay = '';
                if (this.settings.oscEnabled) {
                    const oscCommand = event.oscCommand || '';
                    oscDisplay = `
                        <div style="margin-top: 6px;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 2px;">OSC Command:</label>
                            <input type="text" value="${oscCommand}" onchange="app.updateEventOSC(${index}, this.value)" 
                                   placeholder="/cue/1/start" 
                                   style="width: 100%; padding: 4px 8px; background: #0a0a0a; border: 1px solid #2196f3; border-radius: 4px; color: #2196f3; font-size: 11px;">
                        </div>
                    `;
                }

                // API Command Display (solo se API √® attivo)
                let apiDisplay = '';
                if (this.settings.apiEnabled) {
                    const apiCommand = event.apiCommand || '';
                    apiDisplay = `
                        <div style="margin-top: 6px;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 2px;">API Endpoint:</label>
                            <input type="text" value="${apiCommand}" onchange="app.updateEventAPI(${index}, this.value)" 
                                   placeholder="/api/trigger/event1" 
                                   style="width: 100%; padding: 4px 8px; background: #0a0a0a; border: 1px solid #4caf50; border-radius: 4px; color: #4caf50; font-size: 11px;">
                        </div>
                    `;
                }

                // GPIO Command Display (solo se GPIO √® attivo)
                let gpioDisplay = '';
                if (this.settings.gpioEnabled) {
                    const gpioCommand = event.gpioCommand || '';
                    gpioDisplay = `
                        <div style="margin-top: 6px;">
                            <label style="font-size: 10px; color: #888; display: block; margin-bottom: 2px;">GPIO Pin:</label>
                            <input type="text" value="${gpioCommand}" onchange="app.updateEventGPIO(${index}, this.value)" 
                                   placeholder="Es: 5, 12, 23..." 
                                   style="width: 100%; padding: 4px 8px; background: #0a0a0a; border: 1px solid #ff9800; border-radius: 4px; color: #ff9800; font-size: 11px;">
                        </div>
                    `;
                }

                const activeEvents = this.events.filter(e => e.status !== 'completed');
                const eventPosition = activeEvents.indexOf(event);
                const isFirst = eventPosition === 0;
                const isLast = eventPosition === activeEvents.length - 1;

                return `
                    <div class="event-item cat-${event.category} ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}" 
                         draggable="${!isCompleted}" 
                         data-index="${index}">
                        <div class="event-header">
                            <div class="event-info">
                                <div class="event-category category-${event.category}">${event.category}${startTimeDisplay}</div>
                                <div class="event-title" contenteditable="true" onblur="app.updateEventName(${index}, this.textContent)" style="outline: none; cursor: text;">${event.name}</div>
                                ${xptDisplay}
                                ${ptzDisplay}
                                ${oscDisplay}
                                ${apiDisplay}
                                ${gpioDisplay}
                                ${event.notes ? `<div class="event-notes">${event.notes}</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: flex-start;">
                                <div>
                                    <div class="event-timer ${timerClass}">
                                        ${event.status === 'running' ? '-' : ''}${this.formatTime(Math.abs(remaining))}
                                    </div>
                                    <div class="event-duration">Durata: ${this.formatTime(event.duration)}</div>
                                </div>
                                ${!isCompleted ? `
                                    <div class="event-order-controls">
                                        <button class="btn-arrow" onclick="app.moveEventUp(${index})" ${isFirst ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>‚ñ≤</button>
                                        <button class="btn-arrow" onclick="app.moveEventDown(${index})" ${isLast ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}>‚ñº</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="event-controls">
                            ${event.status === 'running' ? 
                                `<button class="btn btn-small btn-danger" onclick="app.stopEvent(${index})">Pausa</button>` :
                                `<button class="btn btn-small btn-success" onclick="app.startEvent(${index})">Start</button>`
                            }
                            <button class="btn btn-small" onclick="app.resetEvent(${index})">Reset</button>
                            ${isCompleted ? 
                                `<button class="btn btn-small btn-success" onclick="app.completeEvent(${index})">‚úì Completato</button>` :
                                `<button class="btn btn-small" onclick="app.completeEvent(${index})">‚úì Completa</button>`
                            }
                            <button class="btn btn-small btn-danger" onclick="app.deleteEvent(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            },

            setupDragAndDrop() {
                const items = document.querySelectorAll('.event-item[draggable="true"]');
                
                items.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', item.innerHTML);
                        item.classList.add('dragging');
                    });

                    item.addEventListener('dragend', (e) => {
                        item.classList.remove('dragging');
                        items.forEach(i => i.classList.remove('drag-over'));
                    });

                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        item.classList.add('drag-over');
                        return false;
                    });

                    item.addEventListener('dragleave', (e) => {
                        item.classList.remove('drag-over');
                    });

                    item.addEventListener('drop', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const draggedIndex = parseInt([...items].find(i => i.classList.contains('dragging')).dataset.index);
                        const targetIndex = parseInt(item.dataset.index);
                        
                        if (draggedIndex !== targetIndex) {
                            const draggedEvent = this.events[draggedIndex];
                            
                            // Se l'evento trascinato era il primo con orario, trasferisci l'orario al nuovo primo
                            const wasFirstWithTime = draggedIndex === 0 && draggedEvent.startTime;
                            
                            this.events.splice(draggedIndex, 1);
                            this.events.splice(targetIndex, 0, draggedEvent);
                            
                            // Se il primo evento √® cambiato e aveva un orario, trasferiscilo al nuovo primo
                            if (wasFirstWithTime && targetIndex !== 0) {
                                const oldFirstTime = draggedEvent.startTime;
                                draggedEvent.startTime = null;
                                if (this.events[0]) {
                                    this.events[0].startTime = oldFirstTime;
                                }
                            }
                            
                            this.saveToLocalStorage();
                            this.render();
                        }
                        
                        items.forEach(i => i.classList.remove('drag-over'));
                        return false;
                    });
                });
            },

            updateEventName(index, newName) {
                const trimmedName = newName.trim();
                if (trimmedName && this.events[index]) {
                    this.events[index].name = trimmedName;
                    this.saveToLocalStorage();
                    this.render();
                } else {
                    // Se il nome √® vuoto, ripristina il nome originale
                    this.render();
                }
            },

            updateEventXPT(index, newXPT) {
                if (this.events[index]) {
                    this.events[index].xpt = newXPT || null;
                    this.saveToLocalStorage();
                    this.render();
                }
            },

            updateEventPTZ(index, ptzMemory) {
                if (this.events[index]) {
                    this.events[index].ptzMemory = ptzMemory.trim() || null;
                    this.saveToLocalStorage();
                    console.log(`Event ${index}: PTZ Memory set to ${ptzMemory}`);
                }
            },

            updateEventOSC(index, oscCommand) {
                if (this.events[index]) {
                    this.events[index].oscCommand = oscCommand.trim() || null;
                    this.saveToLocalStorage();
                    console.log(`Event ${index}: OSC Command set to ${oscCommand}`);
                }
            },

            updateEventAPI(index, apiCommand) {
                if (this.events[index]) {
                    this.events[index].apiCommand = apiCommand.trim() || null;
                    this.saveToLocalStorage();
                    console.log(`Event ${index}: API Command set to ${apiCommand}`);
                }
            },

            updateEventGPIO(index, gpioCommand) {
                if (this.events[index]) {
                    this.events[index].gpioCommand = gpioCommand.trim() || null;
                    this.saveToLocalStorage();
                    console.log(`Event ${index}: GPIO Pin set to ${gpioCommand}`);
                }
            },

            moveEventUp(index) {
                const activeEvents = this.events.filter(e => e.status !== 'completed');
                const event = this.events[index];
                const activeIndex = activeEvents.indexOf(event);
                
                if (activeIndex > 0) {
                    const targetEvent = activeEvents[activeIndex - 1];
                    const targetIndex = this.events.indexOf(targetEvent);
                    
                    // Scambia gli eventi
                    [this.events[index], this.events[targetIndex]] = [this.events[targetIndex], this.events[index]];
                    
                    this.saveToLocalStorage();
                    this.render();
                }
            },

            moveEventDown(index) {
                const activeEvents = this.events.filter(e => e.status !== 'completed');
                const event = this.events[index];
                const activeIndex = activeEvents.indexOf(event);
                
                if (activeIndex < activeEvents.length - 1) {
                    const targetEvent = activeEvents[activeIndex + 1];
                    const targetIndex = this.events.indexOf(targetEvent);
                    
                    // Scambia gli eventi
                    [this.events[index], this.events[targetIndex]] = [this.events[targetIndex], this.events[index]];
                    
                    this.saveToLocalStorage();
                    this.render();
                }
            },

            updateSettings() {
                this.settings.mixer = document.getElementById('settingsMixer').value;
                this.settings.mixerIP = document.getElementById('mixerIP')?.value || '';
                this.settings.mixerPort = document.getElementById('mixerPort')?.value || '';
                this.settings.ptzEnabled = document.getElementById('settingsPTZ').checked;
                this.settings.ptzProtocol = document.getElementById('ptzProtocol')?.value || 'panasonic';
                this.settings.ptzIP = document.getElementById('ptzIP')?.value || '';
                this.settings.ptzPort = document.getElementById('ptzPort')?.value || '';
                this.settings.oscEnabled = document.getElementById('settingsOSC').checked;
                this.settings.oscIP = document.getElementById('oscIP')?.value || '127.0.0.1';
                this.settings.oscPortIn = document.getElementById('oscPortIn')?.value || '8000';
                this.settings.oscPortOut = document.getElementById('oscPortOut')?.value || '9000';
                this.settings.apiEnabled = document.getElementById('settingsAPI').checked;
                this.settings.apiEndpoint = document.getElementById('apiEndpoint')?.value || '';
                this.settings.apiKey = document.getElementById('apiKey')?.value || '';
                this.settings.gpioEnabled = document.getElementById('settingsGPIO').checked;
                this.settings.gpioIP = document.getElementById('gpioIP')?.value || '';
                this.settings.gpioPort = document.getElementById('gpioPort')?.value || '';
                
                this.saveSettings();
                this.updateActiveSettingsDisplay();
                console.log('Settings updated:', this.settings);
            },

            openSettings() {
                document.getElementById('settingsModal').style.display = 'block';
                this.loadSettingsToForm();
            },

            openCompanion() {
                alert('üéõÔ∏è Companion Integration\n\nFunzionalit√† in arrivo!\n\nQuesta funzione permetter√† di:\n- Configurare connessione a Bitfocus Companion\n- Mappare eventi ai button di Companion\n- Inviare comandi automatici al cambio evento\n- Sincronizzare XPT con i button');
            },

            closeSettings() {
                document.getElementById('settingsModal').style.display = 'none';
            },

            saveSettingsAndClose() {
                this.updateSettings();
                this.closeSettings();
                alert('Settings salvate con successo!');
            },

            loadSettingsToForm() {
                document.getElementById('settingsMixer').value = this.settings.mixer || 'none';
                document.getElementById('mixerIP').value = this.settings.mixerIP || '';
                document.getElementById('mixerPort').value = this.settings.mixerPort || '';
                document.getElementById('settingsPTZ').checked = this.settings.ptzEnabled || false;
                document.getElementById('ptzProtocol').value = this.settings.ptzProtocol || 'panasonic';
                document.getElementById('ptzIP').value = this.settings.ptzIP || '';
                document.getElementById('ptzPort').value = this.settings.ptzPort || '';
                document.getElementById('settingsOSC').checked = this.settings.oscEnabled || false;
                document.getElementById('oscIP').value = this.settings.oscIP || '127.0.0.1';
                document.getElementById('oscPortIn').value = this.settings.oscPortIn || '8000';
                document.getElementById('oscPortOut').value = this.settings.oscPortOut || '9000';
                document.getElementById('settingsAPI').checked = this.settings.apiEnabled || false;
                document.getElementById('apiEndpoint').value = this.settings.apiEndpoint || '';
                document.getElementById('apiKey').value = this.settings.apiKey || '';
                document.getElementById('settingsGPIO').checked = this.settings.gpioEnabled || false;
                document.getElementById('gpioIP').value = this.settings.gpioIP || '';
                document.getElementById('gpioPort').value = this.settings.gpioPort || '';

                this.updateMixerType();
                this.togglePTZ();
                this.toggleOSC();
                this.toggleAPI();
                this.toggleGPIO();
            },

            updateMixerType() {
                const mixerType = document.getElementById('settingsMixer').value;
                const ipSettings = document.getElementById('mixerIPSettings');
                
                if (mixerType !== 'none') {
                    ipSettings.style.display = 'block';
                } else {
                    ipSettings.style.display = 'none';
                }
                
                this.updateSettings();
            },

            toggleOSC() {
                const enabled = document.getElementById('settingsOSC').checked;
                document.getElementById('oscSettings').style.display = enabled ? 'block' : 'none';
                this.updateSettings();
            },

            togglePTZ() {
                const enabled = document.getElementById('settingsPTZ').checked;
                document.getElementById('ptzSettings').style.display = enabled ? 'block' : 'none';
                this.updateSettings();
            },

            toggleAPI() {
                const enabled = document.getElementById('settingsAPI').checked;
                document.getElementById('apiSettings').style.display = enabled ? 'block' : 'none';
                this.updateSettings();
            },

            toggleGPIO() {
                const enabled = document.getElementById('settingsGPIO').checked;
                document.getElementById('gpioSettings').style.display = enabled ? 'block' : 'none';
                this.updateSettings();
            },

            updateActiveSettingsDisplay() {
                const container = document.getElementById('activeSettings');
                const content = document.getElementById('activeSettingsContent');
                
                const active = [];
                
                if (this.settings.mixer !== 'none') {
                    const mixerNames = {
                        'blackmagic': 'Blackmagic ATEM',
                        'sony_xvs': 'Sony XVS',
                        'grass_valley': 'Grass Valley',
                        'for_a': 'FOR-A'
                    };
                    active.push(mixerNames[this.settings.mixer]);
                }
                
                if (this.settings.ptzEnabled) {
                    const ptzNames = {
                        'panasonic': 'PTZ Panasonic',
                        'sony': 'PTZ Sony',
                        'visca': 'PTZ VISCA'
                    };
                    active.push(ptzNames[this.settings.ptzProtocol]);
                }
                
                if (this.settings.oscEnabled) active.push('OSC');
                if (this.settings.apiEnabled) active.push('API');
                if (this.settings.gpioEnabled) active.push('GPI/O');
                
                if (active.length > 0) {
                    content.innerHTML = active.map(item => 
                        `<span style="display: inline-block; padding: 4px 8px; background: #2a2a2a; border-radius: 4px; margin-right: 8px; margin-bottom: 5px; font-size: 12px;">${item}</span>`
                    ).join('');
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            },

            testConnection() {
                const mixer = this.settings.mixer;
                const messages = [];
                
                if (mixer !== 'none') {
                    messages.push(`Testing ${mixer} at ${this.settings.mixerIP}:${this.settings.mixerPort}...`);
                }
                
                if (this.settings.oscEnabled) {
                    messages.push(`Testing OSC at ${this.settings.oscIP}:${this.settings.oscPortIn}/${this.settings.oscPortOut}...`);
                }
                
                if (this.settings.apiEnabled) {
                    messages.push(`Testing API at ${this.settings.apiEndpoint}...`);
                }
                
                if (this.settings.gpioEnabled) {
                    messages.push(`Testing GPIO at ${this.settings.gpioIP}:${this.settings.gpioPort}...`);
                }
                
                if (messages.length > 0) {
                    alert('üîå Test Connessione:\n\n' + messages.join('\n') + '\n\n‚ö†Ô∏è Questa √® una funzione di test. Implementare la logica di connessione reale.');
                } else {
                    alert('‚ö†Ô∏è Nessun dispositivo configurato da testare.');
                }
            },

            loadSettings() {
                const saved = localStorage.getItem('rundown_settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                }
                
                this.updateActiveSettingsDisplay();
            },

            saveSettings() {
                localStorage.setItem('rundown_settings', JSON.stringify(this.settings));
            },

            resetAll() {
                if (confirm('‚ö†Ô∏è ATTENZIONE: Questa operazione canceller√† TUTTO (eventi, statistiche, impostazioni) e ricaricher√† la pagina. Sei sicuro?')) {
                    // Ferma tutti i timer
                    Object.values(this.timers).forEach(timer => clearInterval(timer));
                    if (this.showTimer) clearInterval(this.showTimer);
                    if (this.countdownTimer) clearInterval(this.countdownTimer);
                    if (this.autoStartTimer) clearInterval(this.autoStartTimer);
                    
                    // Cancella tutto dal localStorage
                    localStorage.removeItem('rundown_events');
                    localStorage.removeItem('rundown_autoAdvance');
                    localStorage.removeItem('rundown_showStarted');
                    localStorage.removeItem('rundown_currentShowTime');
                    
                    // Ricarica la pagina
                    location.reload();
                }
            },

            saveToLocalStorage() {
                localStorage.setItem('rundown_events', JSON.stringify(this.events));
                localStorage.setItem('rundown_autoAdvance', this.autoAdvance);
                localStorage.setItem('rundown_showStarted', this.showStarted);
                localStorage.setItem('rundown_currentShowTime', this.currentShowTime);
            },

            loadFromLocalStorage() {
                const saved = localStorage.getItem('rundown_events');
                if (saved) {
                    this.events = JSON.parse(saved);
                }
                const autoAdvance = localStorage.getItem('rundown_autoAdvance');
                if (autoAdvance !== null) {
                    this.autoAdvance = autoAdvance === 'true';
                }
                const showStarted = localStorage.getItem('rundown_showStarted');
                if (showStarted !== null) {
                    this.showStarted = showStarted === 'true';
                }
                const currentShowTime = localStorage.getItem('rundown_currentShowTime');
                if (currentShowTime !== null) {
                    this.currentShowTime = parseInt(currentShowTime) || 0;
                }
            },

            saveRundown() {
                this.saveToLocalStorage();
                alert('Rundown salvato con successo!');
            },

            loadRundown() {
                if (confirm('Caricare l\'ultimo rundown salvato? I dati correnti non salvati andranno persi.')) {
                    this.loadFromLocalStorage();
                    this.render();
                    this.updateStats();
                    if (this.showStarted) {
                        this.startShowTimer();
                    }
                }
            },

            clearAll() {
                if (confirm('Eliminare tutti gli eventi? Questa azione non pu√≤ essere annullata.')) {
                    Object.values(this.timers).forEach(timer => clearInterval(timer));
                    this.timers = {};
                    if (this.showTimer) {
                        clearInterval(this.showTimer);
                        this.showTimer = null;
                    }
                    this.events = [];
                    this.currentEventIndex = -1;
                    this.currentShowTime = 0;
                    this.showStarted = false;
                    this.saveToLocalStorage();
                    this.render();
                    this.updateStats();
                    this.updateCountdown(); // Forza aggiornamento countdown
                }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
